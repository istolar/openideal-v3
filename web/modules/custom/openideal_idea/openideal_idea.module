<?php

/**
 * @file
 * Contains openideal_idea.module.
 */

use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_form_alter().
 */
function openideal_idea_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  if (!in_array($form_id, ['node_idea_edit_form', 'node_idea_form'])) {
    return;
  }

  // Get settings page for default challenge entity.
  $openideal_config = config_pages_config('openideal_configurations');
  if (!empty($openideal_config)) {
    // Get default challenge entity.
    $default_challenge = $openideal_config->field_default_challenge->entity;
  }

  if (
      !empty($default_challenge)
      && empty($form['field_challenge']['widget'][0]['target_id']['#default_value'])
  ) {
    // Set default value for challenge form element of the idea content type.
    $form['field_challenge']['widget'][0]['target_id']['#default_value'] = $default_challenge;
  }

  // Move duplicate form elements to the fieldset.
  $form['duplicate_fieldset'] = [
    '#type' => 'fieldset',
    '#title' => t('Duplicate idea'),
    '#weight' => 100,
  ];
  $form['duplicate_fieldset']['field_duplicate'] = $form['field_duplicate'];
  $form['duplicate_fieldset']['field_duplicate_of'] = $form['field_duplicate_of'];
  unset($form['field_duplicate']);
  unset($form['field_duplicate_of']);

  // Added visibility states to field_duplicate_of form element.
  $form['duplicate_fieldset']['field_duplicate_of']['#states'] = [
    'visible' => [
      ':input[name="field_duplicate[value]"]' => ['checked' => TRUE],
    ],
  ];
}
